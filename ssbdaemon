#!/bin/bash

if [ $# -eq 0 ]
then
	$0 --cwdevice=null --nofork -i --system=n
	exit
fi

voice_dir="/home/onno/audio/Karen"
cwdaemon="/usr/sbin/cwdaemon"
logfile="/home/onno/audio/ssbdaemon.log"

audio_extension="aiff"

request="cwdaemon:II: request: "
abort="cwdaemon:II: requested aborting of message"
tune="cwdaemon:II: requested tuning"

play_cmd="play"

function make_sound() {
	echo "$(date --rfc-3339=sec): $1" >> "${logfile}"
	"${play_cmd}" -q "$@" -t alsa
}

function speak(){
	if [ -f "${1}.${audio_extension}" ]
	then
		make_sound "${1}.${audio_extension}"
	else
		fileList=""
		while read char
		do
			case "${char}" in
				'.')
					char="decimal"
					;;
				'/')
					char="stroke"
					;;
				'?')
					char="query"
					;;
				' ')
					char="space"
					;;
			esac
			if [ -f "${char}.${audio_extension}" ]
			then
				fileList+="${char}.${audio_extension} "
			elif [ -f "${char^^}.${audio_extension}" ]
			then
				fileList+="${char^^}.${audio_extension} "
			elif [ -f "${char,,}.${audio_extension}" ]
			then
				fileList+="${char,,}.${audio_extension} "
			fi
		done < <(echo -n "$@" | sed 's|.|&\n|g')
		make_sound ${fileList}
	fi
}

function extract_requests(){
	while read line
	do
		message=$(echo -n "${line}" | cut -d'"' -f2)
		speak "${message}"
	done < <(stdbuf -oL grep -F "${request}")
}

function extract_aborts(){
	while read line
	do
		killall -s SIGINT -q "${play_cmd}"
	done < <(stdbuf -oL grep -F "${abort}")
}

function extract_tuning(){
	while read line
	do
		speak tune
	done < <(stdbuf -oL grep -F "${tune}")
}

cd "${voice_dir}"
${cwdaemon} "$@" 2> /dev/null | tee >(extract_aborts) | tee >(extract_tuning) | extract_requests
